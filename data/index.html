<!DOCTYPE html>
<html>
<head>
    <title>ESP32 Motor Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.0/nipplejs.min.js"></script>
    <style>
        /*Style the div that holds the joystick*/
        #joystick {
            width: 100px;
            height: 100px;
            position: fixed;
            left: 40px;
            top: '50%';
            transform: translateY(-50%);
            border: 3px slateblue;
        }
        /* camera stream div */
        #stream {
            width: 640px;
            height: 480px;
            margin: 20px auto;
            display: block;
        }
    </style>
</head>
<body style="text-align:center; font-family:Arial, sans-serif;">
    <h1 style="color:blue;">ESP32 Motor Control</h1>
    <p style="font-style: italic; text-shadow: 2px 2px 5px gray">Welcome to the ESP32 motor control interface!</p>

    <!-- img element for camera feed -->
    <img id="stream" src="">
    
    <div id="joystick"></div>
    
    <script>
        // connect to WebSocket
        const socket = new WebSocket('ws://' + window.location.hostname + '/ws');
        // === HIGHLIGHT: Set binaryType to handle JPEG frames === //
        socket.binaryType = 'arraybuffer';

        // when connected
        socket.onopen = () => {
            console.log('WebSocket connected!');
        };

        // === HIGHLIGHT: Updated onmessage to handle text and binary data === //
        socket.onmessage = (event) => {
            if (typeof event.data === 'string') {
                // Handle text messages (joystick-related)
                console.log('ESP32 says:', event.data);
            } else {
                // Handle binary messages (camera JPEG frames)
                const img = document.getElementById('stream');
                const blob = new Blob([event.data], { type: 'image/jpeg' });
                img.src = URL.createObjectURL(blob);
            }
        };

        // create and configure the nipple.js joystick
        const joystick = nipplejs.create({
            zone: document.getElementById('joystick'), // Attach joystick to the #joystick div
            mode: 'static', // 
            position: { left: '50%', top: '50%' }, // Center the joystick in the div
            color: 'blue', // Set joystick color to blue
            size: 100 // Set joystick diameter to 100 pixels
        });

        // Event listener for joystick movement
        joystick.on('move', function(evt, data) {
            // Check if movement data includes direction and distance
            if (data.direction && data.distance) {
                const angle = data.angle.degree; // 0 is right, moving clockwise
                const speed = Math.min(data.distance / 50, 1) * 100; // Normalize distance to 0-100%
                
                //send data back to esp
                socket.send("SPEED: " + speed + "--" + "ANGLE: " + angle);
            }
        });

        // Event listener for when the joystick is released
        joystick.on('end', function() {
            // Send a request to stop the motors (angle=0, speed=0)
            socket.send("AT REST");
        });
    </script>
</body>
</html>